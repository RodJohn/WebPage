
# JSONP

## 原理

    浏览器允许静态资源跨域
    通过动态创建script，再请求一个带参网址实现跨域通信
    
## 实现

原生实现
```
 <script>
    var script = document.createElement('script');
    script.type = 'text/javascript';

    // 传参并指定回调执行函数为onBack
    script.src = 'http://www.domain2.com:8080/login?user=admin&callback=onBack';
    document.head.appendChild(script);

    // 回调执行函数
    function onBack(res) {
        alert(JSON.stringify(res));
    }
 </script>
 
 服务端返回如下（返回时即执行全局函数）：
 onBack({"status": true, "user": "admin"})
```

jquery ajax
```
$.ajax({
    url: 'http://www.domain2.com:8080/login',
    type: 'get',
    dataType: 'jsonp',  // 请求方式为jsonp
    jsonpCallback: "onBack",    // 自定义回调函数名
    data: {}
});
```
    

## 分析
    
    JSONP只支持GET请求


# window.name + iframe

## 原理

基础知识

    iframe
        iframe是html的一个标签，可以在网页中创建内联框架，
        它有个src属性（指向文件地址，html、php等）可以选择内联框架的内容，
    window.name        
        window.name（一般在js代码里出现）的值不是一个普通的全局变量，而是当前窗口的名字，
        每个iframe都有包裹它的window，而这个window是top window的子窗口，而它自然也有window.name的属性，
        window.name属性的神奇之处在于
        name 值在不同的页面（甚至不同域名）加载后依旧存在（如果没修改则值不会变化），
        并且可以支持非常长的 name 值（2MB）。
原理
    
    通过iframe的src属性由外域转向本地域，
    跨域数据即由iframe的window.name从外域传递到本地域。
    这个就巧妙地绕过了浏览器的跨域访问限制，但同时它又是安全操作。

## 实现

a.html：(http://www.domain1.com/a.html)
```
var proxy = function(url, callback) {
    var state = 0;
    var iframe = document.createElement('iframe');

    // 加载跨域页面
    iframe.src = url;

    // onload事件会触发2次，第1次加载跨域页，并留存数据于window.name
    iframe.onload = function() {
        if (state === 1) {
            // 第2次onload(同域proxy页)成功后，读取同域window.name中数据
            callback(iframe.contentWindow.name);
            destoryFrame();

        } else if (state === 0) {
            // 第1次onload(跨域页)成功后，切换到同域代理页面
            iframe.contentWindow.location = 'http://www.domain1.com/proxy.html';
            state = 1;
        }
    };

    document.body.appendChild(iframe);

    // 获取数据以后销毁这个iframe，释放内存；这也保证了安全（不被其他域frame js访问）
    function destoryFrame() {
        iframe.contentWindow.document.write('');
        iframe.contentWindow.close();
        document.body.removeChild(iframe);
    }
};

// 请求跨域b页面数据
proxy('http://www.domain2.com/b.html', function(data){
    alert(data);
});

```

proxy.html：(http://www.domain1.com/proxy....

    中间代理页，与a.html同域，内容为空即可。

b.html：(http://www.domain2.com/b.html)

    <script>
        window.name = 'This is domain2 data!';
    </script>
    

## 分析



# 参考

https://www.cnblogs.com/zichi/p/4620656.html
